<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>社區管委會-社區行事曆</title>
   <link rel="stylesheet" href="./lib/fontIcon/css/all.min.css">
   <link rel="stylesheet" href="./lib/calendar/core/main.min.css">
	<link rel="stylesheet" href="./lib/calendar/daygrid/main.min.css">
   <link rel="stylesheet" href="./lib/bs4/bootstrap.min.css">
   <link rel="stylesheet" href="./lib/toastr/toastr.min.css">
   <link rel="stylesheet" href="./css/calendar.css">
   <link rel="stylesheet" href="./css/committeeCal.css">
   <script src="./lib/calendar/core/main.min.js"></script>
   <script src="./lib/calendar/daygrid/main.min.js"></script>
   <script src="./lib/calendar/interaction/interaction.js"></script>
   <script src="./lib/axios/axios.min.js"></script>
   <script src="./lib/jquery.3.4.1.min.js"></script>
   <script src="./lib/toastr/toastr.min.js"></script>
   <script src="./lib/bs4/bootstrap.bundle.min.js"></script>
</head>
<body>
   <div class="wrap">
      <div class="searchBox">
         <div class="searchRow">
            <input 
               type="text" 
               class="form-control keyword" 
               placeholder="活動關鍵字搜尋">
            <i class="fal fa-search"></i>
         </div>
      </div>

      <!-- 排班 -->
      <div class="shiftTable">
         <div class="controlBar view">
            <div class="arrowBox arrowPrev">
               <i class="far fa-chevron-left"></i>
            </div>
            <div class="dateBox">
               <p class="yearText"></p>
               <p>年</p>
               <p class="monthText"></p>
               <p>月</p>
            </div>
            <div class="arrowBox arrowNext">
               <i class="far fa-chevron-right"></i>
            </div>
         </div>
         <div id="calendar"></div>
      </div>

      <!-- modal -->
      <div class="modal fade" id="editModal">
         <div class="modal-dialog">
            <div class="modal-content">
               <div class="modal-header">
                  <h1 class="modal-title">活動內容</h1>
               </div>
               <div class="modal-body">
                  <div class="formBox">
                     <div class="formRow">
                        <p class="formTitle">活動名稱</p>
                        <input 
                           type="text" 
                           class="form-control activityTitle"
                           placeholder="輸入活動名稱">
                     </div>
                     <div class="formRow">
                        <p class="formTitle">活動日期</p>
                        <input type="date" class="form-control activityDate">
                        <i class="fal fa-calendar-alt"></i>
                     </div>
                     <div class="formRow">
                        <p class="formTitle">開始時間</p>
                        <select class="form-control startTime"></select>
                        <i class="fas fa-sort-down"></i>
                     </div>
                     <div class="formRow">
                        <p class="formTitle">結束時間</p>
                        <select class="form-control endTime"></select>
                        <i class="fas fa-sort-down"></i>
                     </div>
                     <div class="formRow">
                        <p class="formTitle">備註</p>
                        <textarea 
                           class="form-control remark" 
                           placeholder="輸入備註"
                        ></textarea>
                     </div>
                  </div>
                  <div class="notifyBox">
                     <button class="btnPush">推播通知</button>
                     <button class="btnInbox">收件夾通知</button>
                  </div>
               </div>
               <div class="modal-footer">
                  <button class="btnRemove">刪除活動</button>
                  <button class="btnModify">修改</button>
               </div>
            </div>
         </div>
       </div>

   </div>

   <script type="module">
      import ShiftAjax from './js/modules/ShiftAjax.js';
      import SearchPanel from './js/modules/community/SearchPanel.js';
      import DatePanel from './js/modules/community/DatePanel.js';
      import ShiftCalendar from './js/modules/community/ShiftCalendar.js';
      import EditModal from './js/modules/community/EditModal.js';
      import helper from './js/modules/community/Helper.js';
      import Toastr from './js/modules/Toastr.js';
      let today = new Date();
      let criteria = {
         keyword: '',
         year: today.getFullYear(),
         month: today.getMonth() + 1
      };

      let criteriaProxy = new Proxy(criteria, {
         get(target, key) {
            return target[key];
         },
         async set(target, key, value) {
            target[key] = value;
            if (key !== 'year') {
               let shiftData = await shiftAjax.getCommunity(target).then(res => res);
               shiftData = helper.convertData(shiftData);
               shiftCalendar.addEvent(shiftData);
            }
            return true;
         }
      });

      let myToastr = new Toastr({ toastrObj: toastr });

      let shiftAjax = new ShiftAjax({
         communityApi: 'http://localhost:3034/cal/community',
         toastr: myToastr
      });

      let searchPanel = new SearchPanel({
         keywordEl: '.keyword',
         searchEvent({ key, value }) {
            criteriaProxy[key] = value;
         }
      });

      let datePanel = new DatePanel({
			yearEl: '.yearText',
			monthEl: '.monthText',
			btnPrev: '.arrowPrev',
         btnNext: '.arrowNext',
         defaultDate: today,
			prevHandler() {
            shiftCalendar.prevMonth();
				return shiftCalendar.getDate();
			},
			nextHandler() {
            shiftCalendar.nextMonth();
				return shiftCalendar.getDate();
         },
         changeHandler({ year, month }) {
            criteriaProxy.year = year;
            criteriaProxy.month = month;
         }
		});

		let shiftCalendar = new ShiftCalendar({
         el: '#calendar',
			option: {
            defaultDate: today,
            editable: false,
            droppable: false,
            events: [],
            eventClick(info) {
               editModal.updateInfo(info);
            }
			}
      });

      let editModal = new EditModal({
         rootEl: '#editModal',
         titleEl: '.activityTitle',
         dateEl: '.activityDate',
         startTimeEl: '.startTime',
         endTimeEl: '.endTime',
         remarkEl: '.remark',
         pushEl: '.btnPush',
         inBoxEl: '.btnInbox',
         removeEl: '.btnRemove',
         modifyEl: '.btnModify'
      });

      let init = async function() {
         let shiftData = await shiftAjax.getCommunity(criteria).then(res => res);
         shiftData = helper.convertData(shiftData);
         shiftCalendar.addEvent(shiftData);
      }

      init();

   </script>
</body>
</html>