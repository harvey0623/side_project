<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>社區-人員班表</title>
   <link rel="stylesheet" href="./lib/fontIcon/css/all.min.css">
   <link rel="stylesheet" href="./lib/calendar/core/main.min.css">
	<link rel="stylesheet" href="./lib/calendar/daygrid/main.min.css">
   <link rel="stylesheet" href="./lib/bs4/bootstrap.min.css">
   <link rel="stylesheet" href="./lib/toastr/toastr.min.css">
   <link rel="stylesheet" href="./css/calendar.css">
   <script src="./lib/calendar/core/main.min.js"></script>
   <script src="./lib/calendar/daygrid/main.min.js"></script>
   <script src="./lib/calendar/interaction/interaction.js"></script>
   <script src="./lib/axios/axios.min.js"></script>
   <script src="./lib/jquery.3.4.1.min.js"></script>
   <script src="./lib/toastr/toastr.min.js"></script>
</head>
<body>
   <div class="wrap">
      <!-- 排班 -->
      <div class="shiftTable">
         <div class="controlBar view layout">
            <div class="searchBox">
               <div class="searchRow">
                  <select class="form-control company"></select>
                  <i class="fas fa-sort-down"></i>
               </div>
            </div>
            <div class="groupBox">
               <div class="dateBox">
                  <p class="yearText"></p>
                  <p>年</p>
                  <p class="monthText"></p>
                  <p>月</p>
               </div>
               <div class="arrowBox arrowPrev">
                  <i class="far fa-chevron-left"></i>
               </div>
               <div class="arrowBox arrowNext">
                  <i class="far fa-chevron-right"></i>
               </div>
            </div>
         </div>
         <div id="calendar"></div>
      </div>
   </div>

   <script type="module">
      import ShiftAjax from './js/modules/ShiftAjax.js';
      import SearchPanel from './js/modules/community/SearchPanel.js';
      import DatePanel from './js/modules/community/DatePanel.js';
      import ShiftCalendar from './js/modules/community/ShiftCalendar.js';
      import Toastr from './js/modules/Toastr.js'
      let today = new Date();
      let criteria = {
         company: '',
         year: today.getFullYear(),
         month: today.getMonth() + 1
      };

      let criteriaProxy = new Proxy(criteria, {
         get(target, key) {
            return target[key];
         },
         async set(target, key, value) {
            target[key] = value;
            if (key !== 'year') {
               let shiftData = await shiftAjax.getCommunity(target).then(res => res.data);
               shiftCalendar.addEvent(shiftData);
            }
            return true;
         }
      });

      let myToastr = new Toastr({ toastrObj: toastr });

      let shiftAjax = new ShiftAjax({
         communityApi: 'http://localhost:3034/cal/shift',
         toastr: myToastr
      });

      let searchPanel = new SearchPanel({
         companyEl: '.company',
         searchEvent({ key, value }) {
            criteriaProxy[key] = value;
         }
      });

      let datePanel = new DatePanel({
			yearEl: '.yearText',
			monthEl: '.monthText',
			btnPrev: '.arrowPrev',
         btnNext: '.arrowNext',
         defaultDate: today,
			prevHandler() {
            shiftCalendar.prevMonth();
				return shiftCalendar.getDate();
			},
			nextHandler() {
            shiftCalendar.nextMonth();
				return shiftCalendar.getDate();
         },
         changeHandler({ year, month }) {
            criteriaProxy.year = year;
            criteriaProxy.month = month;
         }
		});

		let shiftCalendar = new ShiftCalendar({
         el: '#calendar',
			option: {
            defaultDate: today,
            editable: false,
            droppable: false,
            events: [],
            eventRender(info) {
               let template = `
                  <div class="name">${info.event.title}</div>
                  <div class="unit">${info.event.extendedProps.unit}</div>`;
               info.el.querySelector('.fc-title').innerHTML = template;
            },
            eventClick(info) {
               console.log(info);
            }
			}
      });

      let init = function() {
         searchPanel.renderCompany([
            { name: 'a公司', id: 'a' },
            { name: 'b公司', id: 'b' }
         ]);
      }

      init();

   </script>
</body>
</html>