<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>Document</title>
	<link rel="stylesheet" href="./infinite_elm.css">
	<link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css'/>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.min.js'></script>
</head>

<body>
	<div class="wrap wrap1">
		<h2 class="title">User list</h2>
		<ul class="userList userList1"></ul>
		<div class="loading loading1">
			<i class="fa fa-circle-o-notch fa-spin fa-2x fa-fw"></i>
			<p>Loading...</p>
		</div>
	</div>

	<div class="wrap wrap2">
		<h2 class="title">Member list</h2>
		<ul class="userList userList2"></ul>
		<div class="loading loading2">
			<i class="fa fa-circle-o-notch fa-spin fa-2x fa-fw"></i>
			<p>Loading...</p>
		</div>
	</div>

	<script>
		class InifinteUi {
			constructor(list, loading) {
				this._list = document.querySelector(list);
				this._loading = document.querySelector(loading);
			}
			renderHTML(data) {
				data.forEach(item => {
					let li = document.createElement('li');
					li.innerHTML = `
						<div class="pic">
							<img src="${item.picture.large}" alt="">
						</div>
						<div class="descBox">
							<p>name: ${item.name.first} ${item.name.last}</p>
							<p>gender: ${item.gender}</p>
							<p>email: ${item.email}</p>
						</div>`;
					this._list.appendChild(li);
				});
			}
			get loading() {
				return this._loading;
			}
		}

		class InfiniteScroll {
			constructor(props) {
				this._target = document.querySelector(props.target);
				this._isLoading = false;
				this._currentPage = 1;
				this._maxPage = 4;
				this._hasNextPage = true;
				this._api = props.api;
				this._view = new InifinteUi(props.list, props.loading);
				this.getData();
				this.bindEvent();
			}
			bindEvent() {
				this._target.addEventListener('scroll', this.scrollHandler.bind(this));
			}
			async getData() {
				this.isLoading = true;
				let result = await axios.get(`${this._api}${this._currentPage}`).then(res => res.data.results);
				this._currentPage++;
				if (this._currentPage > this._maxPage) this.hasNextPage = false;
				this._view.renderHTML(result);
				this.isLoading = false;
			}
			scrollHandler() {
				let clientH = this._target.clientHeight;
				let scrollH = this._target.scrollHeight;
				let diff_h = scrollH - clientH;
				let scrollY = this._target.scrollTop;
            if (scrollY >= diff_h * 0.95 && !this.isLoading && this.hasNextPage) {
					this.getData();
            }
			}
			get isLoading() {
				return this._isLoading;
			}
			set isLoading(val) {
				this._isLoading = val;
				this._view.loading.style.display = val ? 'block' : 'none';
			}
			get hasNextPage() {
				return this._hasNextPage;
			}
			set hasNextPage(val) {
				this._hasNextPage = val;
			}
		}

		let scroller1 = new InfiniteScroll({
			target: '.wrap1',
			list: '.userList1',
			loading: '.loading1',
			api: 'https://randomuser.me/api/?results=18&seed=plane&page='
		});

		let scroller2 = new InfiniteScroll({
			target: '.wrap2',
			list: '.userList2',
			loading: '.loading2',
			api: 'https://randomuser.me/api/?results=18&seed=car&page='
		});
		
	</script>
</body>

</html>