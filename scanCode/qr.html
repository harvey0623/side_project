<html>

<head>
	<meta charset="utf-8">
	<title>jsQR Demo</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="./qr.css">
	<script src="./lib/jsQR.js"></script>
</head>

<body>
	<div class="box">
		<div class="videoBox">
			<canvas id="canvas" class="notActive"></canvas>
			<div class="corner corner1"></div>
			<div class="corner corner2"></div>
			<div class="corner corner3"></div>
			<div class="corner corner4"></div>
		</div>
		<p class="tipText">請掃描 QR code 以存入禮物卡</p>
	</div>
	<script>
		let video = document.createElement("video");
		let canvasElement = document.getElementById("canvas");
		let ctx = canvasElement.getContext("2d");
		let canvasSize = { width: 300, height: 300 };

		function drawLine(begin, end) {
			ctx.beginPath();
			ctx.moveTo(begin.x, begin.y);
			ctx.lineTo(end.x, end.y);
			ctx.lineWidth = 2;
			ctx.strokeStyle = '#FF3B58';
			ctx.stroke();
		}

		function tick() {
			if (video.readyState === video.HAVE_ENOUGH_DATA) {
				canvasElement.classList.remove('notActive');
				ctx.drawImage(video, 0, 0, canvasSize.width, canvasSize.height);
				var { data, width, height } = ctx.getImageData(0, 0, canvasSize.width, canvasSize.height);
				var code = jsQR(data, width, height, {
					inversionAttempts: "dontInvert",
				});
				if (code) {
					drawLine(code.location.topLeftCorner, code.location.topRightCorner);
					drawLine(code.location.topRightCorner, code.location.bottomRightCorner);
					drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner);
					drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner);
				} else {
					alert('發生錯次');
				}
			}
			requestAnimationFrame(tick);
		}

		async function getMedia() {
			try {
				let stream = await navigator.mediaDevices.getUserMedia({ 
					video: { facingMode: "environment" }
				});
				video.srcObject = stream;
				// required to tell iOS safari we don't want fullscreen
				video.setAttribute('playsinline', true);
				video.play();
				requestAnimationFrame(tick);
			} catch(err) {
				
			}
		}


		getMedia();
	</script>
</body>

</html>