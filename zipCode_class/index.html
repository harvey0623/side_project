<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.min.js'></script>
    <style>
        input[readonly] {
            background-color: lightgray;
        }
    </style>
</head>

<body>
    <div class="box">
        <h1>購買人</h1>
        <select class="district"></select>
        <select class="county"></select>
        <input type="text" class="code" readonly>
    </div>
    <div class="box">
        <h1>收貨人</h1>
        <div>
            <span>同購買人資料</span>
            <input type="checkbox" class="same_checkbox">
        </div>
        <select class="district2"></select>
        <select class="county2"></select>
        <input type="text" class="code2" readonly>
    </div>


    <script>
        (function () {
            class View {
                constructor(props) {
                    this._district = View.getDom(props.district);
                    this._county = View.getDom(props.county);
                    this._code = View.getDom(props.code);
                    this._districtUpdate = props.onDistrictUpdate;
                    this._countyUpdate = props.onCountyUpdate;
                    this._default = props.default;
                    this._model = new Model();
                    this.bindEvent();
                    this.init(props.onInit);
                    if (props.displayCode !== undefined && !props.displayCode) {
                        this._code.style.display = 'none';
                    }
                }
                static getDom(name) {
                    let el = document.querySelector(name);
                    if (el === null) throw new Error('can not find the dom');
                    return el;
                }
                async init(cb) {
                    await this._model.getData();
                    this.render_district(this._model.get_district());
                    //判斷是否要執行預設值
                    if (this._default !== undefined && this._default.district !== '') {
                        this.set_district(this._default.district);
                        this.set_county(this._default.county);
                    }
                    if (typeof cb === 'function') cb(this);
                }
                bindEvent() {
                    this._district.addEventListener('change', this.district_change.bind(this, true));
                    this._county.addEventListener('change', this.county_change.bind(this, true));
                }
                render_district(data) {
                    let template = '';
                    data.forEach(item => {
                        template += `<option value="${item.name}-${item.code}">${item.name}</option>`
                    });
                    this._district.innerHTML = template;
                    this.district_change(false);
                }
                render_county(data) {
                    let template = '';
                    data.forEach(item => {
                        template += `<option value="${item.name}-${item.code}">${item.name}</option>`
                    });
                    this._county.innerHTML = template;
                    this.county_change(false);
                }
                district_change(isTrigger) {
                    let district_val = this._district.value.split('-');
                    let parameter = { code: parseInt(district_val[1]) };
                    let countyData = this._model.get_county(parameter);
                    this._model.district = district_val[0];
                    if (isTrigger) {
                        if (typeof this._districtUpdate === 'function') {
                            this._districtUpdate({ //callback
                                district: this._model.district
                            });
                        }
                    }
                    this.render_county(countyData);
                }
                county_change(isTrigger) {
                    let code_val = this._county.value.split('-');
                    this._model.county = code_val[0];
                    this.code_change(parseInt(code_val[1]));
                    if (!isTrigger) return;
                    if (typeof this._countyUpdate === 'function') {
                        this._countyUpdate({  //callback
                            county: this._model.county
                        });
                    }
                }
                code_change(code) {
                    this._code.value = code;
                    this._model.code = code;
                }
                set_district(data) {
                    let isFind = false;
                    let optionArr = Array.from(this._district.querySelectorAll('option'));
                    optionArr.forEach(option => {
                        let option_district = option.value.split('-')[0];
                        if (option_district === data) {
                            option.selected = true;
                            isFind = true
                        }
                    });
                    if (isFind) this.district_change(false);
                }
                set_county(data) {
                    if (!data) return;
                    let isFind = false;
                    let optionArr = Array.from(this._county.querySelectorAll('option'));
                    optionArr.forEach(option => {
                        let option_county = option.value.split('-')[0];
                        if (option_county === data) {
                            option.selected = true;
                            isFind = true;
                        }
                    });
                    if (isFind) this.county_change(false);
                }
                get elm_district() {
                    return this._district;
                }
                get elm_county() {
                    return this._county;
                }
                get output() {
                    return {
                        district: this._model.district,
                        county: this._model.county,
                        code: this._model.code
                    }
                }
            }

            class Model {
                constructor() {
                    this._district = '';
                    this._county = '';
                    this._code = 0;
                    this._zipCode = null;
                }
                async getData() {
                    this.zipCodeData = await axios.get('./zipeCode.json').then(res => res.data.cities);
                }
                get_district() {
                    return this.zipCodeData.map(item => {
                        return { name: item.name, code: item.code };
                    });
                }
                get_county(data) {
                    return this.zipCodeData.filter(item => item.code === data.code)[0]['region'];
                }
                get district() {
                    return this._district;
                }
                set district(val) {
                    this._district = val;
                }
                get county() {
                    return this._county;
                }
                set county(val) {
                    this._county = val;
                }
                get code() {
                    return this._code;
                }
                set code(val) {
                    this._code = val;
                }
            }

            function init() {
                let same_checkbox = document.querySelector('.same_checkbox');
                let isChecked = false;

                let buyer = new View({
                    district: '.district',
                    county: '.county',
                    code: '.code',
                    default: {
                        district: '新北市',
                        county: '新莊區'
                    },
                    displayCode: true,
                    onInit(el) {
            
                    },
                    onDistrictUpdate({ district }) {
                        if (isChecked) receiver.set_district(district);
                    },
                    onCountyUpdate({ county }) {
                        if (isChecked) receiver.set_county(county);
                    }
                });

                let receiver = new View({
                    district: '.district2',
                    county: '.county2',
                    code: '.code2',
                    default: {
                        district: '台中市',
                        county: '大甲區'
                    },
                    displayCode: true,
                });

                same_checkbox.addEventListener('change', function () {
                    isChecked = this.checked;
                    if (isChecked) {
                        receiver.elm_district.disabled = true;
                        receiver.elm_county.disabled = true;
                        let { district, county } = buyer.output;
                        receiver.set_district(district);
                        receiver.set_county(county);
                    } else {
                        receiver.elm_district.disabled = false;
                        receiver.elm_county.disabled = false;
                    }
                });
            }

            init();

        })();


    </script>
</body>

</html>